<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../simpla-element-behavior/simpla-element-behavior.html">

<dom-module id="simpla-collection">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
    </style>

    <template is="dom-if" if="[[editable]]">
      <simpla-collection-editor
        items="{{items}}"
        as="[[as]]"
        active="{{active}}"
        data-edit-button-visible$="[[_editButtonVisible]]"
        on-collection-item-edit="_handleEdit">
      </simpla-collection-editor>
    </template>

    <slot></slot>
  </template>

  <script>
    const EDITOR_IMPORT = 'simpla-collection-editor.html',
          SIMPLA_CONFIG = {
            type: 'Collection',
            dataProperties: [ 'items' ]
          };

    function generateId() {
      return Math.random().toString(36).substr(-5);
    }

    Polymer({
      is: 'simpla-collection',

      properties: {

        /**
         * Items in the collection
         * @type {Array}
         */
        items: {
          type: Array,
          value: () => []
        },

        /**
         * Item name to use throughout
         * @type {String}
         */
        as: {
          type: String,
          value: 'item'
        },

        /**
         * Whether collection editor is open
         * @type {Boolean}
         */
        active: {
          type: Boolean,
          notify: true,
          value: false
        },

        /**
         * Whether collection is editable
         * @type {Boolean}
         */
        editable: {
          type: Boolean,
          observer: '_importEditor',
          notify: true,
          value: false
        },

        _editButtonVisible: Boolean

      },

      listeners: {
        'mouseover': '_showEditButton',
        'mouseout': '_hideEditButton'
      },

      observers: [
        '_render(items.*)'
      ],

      behaviors: [ SimplaBehaviors.Element(SIMPLA_CONFIG) ],

      /**
       * Render the collection
       * @return {undefined}
       */
      _render() {
        let template = Polymer.dom(this).querySelector('template'),
            items = this.items;

        const replaceKeyWith = (fragment, hash) => {
          let attributes = [ 'path', 'sid', 'gid' ];

          attributes.forEach(attr => {
            Array.prototype.forEach.call(fragment.querySelectorAll(`[${attr}]`), node => {
              let magicPath = node.getAttribute(attr);
              node.setAttribute(attr, magicPath.replace(`[${this.as}]`, hash));
            });
          });
        }

        while (this.children.length > 1) {
          Polymer.dom(this).removeChild(this.children[1]);
        }

        items.forEach((item, i) => {
          let fragment = document.importNode(template.content, true);
          replaceKeyWith(fragment, item.id);
          Polymer.dom(this).appendChild(fragment);
        });
      },

      /**
       * Parse edit events from editor and call appropriate action
       * @param  {CustomEvent} e Edit event from simpla-collection-editor
       * @return {undefined}
       */
      _handleEdit(e) {
        let action = e.detail.action,
            args = e.detail.args;

        e.stopPropagation();
        this[action](...args);
      },

      /**
       * Import the editor component on editable
       * @param  {Boolean} editable Whether collection is editable
       * @return {undefined}
       */
      _importEditor(editable) {
        if (editable) {
          this.importHref(this.resolveUrl(EDITOR_IMPORT));
        }
      },

      /**
       * Show the inline edit button based on mouseover
       * More performant to keep button in editor but handle hover with events on mediator
       * @param  {Event} e Mouseover event
       * @return {undefined}
       */
      _showEditButton() {
        this._editButtonVisible = true;
      },

      /**
       * Show the inline edit button based on mouseout
       * More performant to keep button in editor but handle hover with events on mediator
       * @param  {Event} e Mouseout event
       * @return {undefined}
       */
      _hideEditButton() {
        this._editButtonVisible = false;
      }
    });
  </script>
</dom-module>
