<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>simpla-collection</title>

    <!-- Import WCT-->
    <script src="https://unpkg.com/webcomponents.js/@^0.7.24/webcomponents-lite.min.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">
    <script src="../../web-component-tester/browser.js"></script>

    <!-- Import Simpla -->
    <script src="https://unpkg.com/simpla@^2.0.0"></script>

    <!-- Import the element to test -->
    <link rel="import" href="../simpla-collection.html">

  </head>
  <body>
    <script>
      Simpla.init('dummy');
    </script>

    <test-fixture id="default">
      <template>
        <simpla-collection path="/test">
          <template>
            <div class="item" path="/test/[item]"></div>
          </template>
        </simpla-collection>
      </template>
    </test-fixture>
    <script>
      var COLLECTION_PATH = '/test',
          EDITOR_COMPONENT_NAME = 'simpla-collection-editor',
          EDITOR_COMPONENT = 'simpla-collection-editor.html',
          ITEMS = () => [
            { id: 'first' },
            { id: 'second' },
          ];

      function expectedPathForIndex(n, items) {
        items = items || ITEMS();
        return '/test/' + items[n].id;
      }

      function getRenderedItemsFor(component) {
        return component.querySelectorAll('.item');
      }

      describe('<simpla-collection>', function() {
        var component;

        beforeEach(function() {
          component = fixture('default');
          Simpla = window.Simpla;
        });

        it('is okay', function() {
          expect(component).to.be.ok;
        });

        describe('rendering', function() {

          beforeEach(function() {
            component.items = ITEMS();
          });

          it('renders the template for all items in the collection', function() {
            var renderedItems = getRenderedItemsFor(component);

            expect(renderedItems).to.have.length(ITEMS().length);
          });

          it('properly updates rendered DOM when an item is added', function() {
            var itemsBeforeAddition = getRenderedItemsFor(component),
                itemsAfterAddition;

            component.push('items', { id: 'some-item-id' });
            itemsAfterAddition = getRenderedItemsFor(component);

            expect(itemsAfterAddition).to.have.length(itemsBeforeAddition.length + 1);
          });

          it('properly updates rendered DOM when an item is removed', function() {
            var itemsBeforeAddition = getRenderedItemsFor(component),
                itemsAfterAddition;

            component.pop('items');
            itemsAfterAddition = getRenderedItemsFor(component);

            expect(itemsAfterAddition).to.have.length(itemsBeforeAddition.length - 1);
          });

          it('renders in the same order as the items', function() {
            var renderedItems = getRenderedItemsFor(component);

            [].forEach.call(renderedItems, function(element, i) {
              var actualPath = element.getAttribute('path'),
                  expectedPath = expectedPathForIndex(i, component.items);

              expect(actualPath).to.equal(expectedPath);
            });
          });
        });

        describe('templating', function() {

          xit('replaces the [item] key in paths with the item id', function() {

          });

          xit('replaces the [item] key in SIDs and GIDs with the item id', function() {

          });

          xit('replaces the item key in paths when a custom item name is set', function() {

          });

        })

        describe('editor', function() {

          it('imports the editor component when editable is true', function() {
            Simpla.editable(true);
            expect(document.head.querySelector('link[href$="' + EDITOR_COMPONENT + '"]')).to.be.ok;
          });

        });

        describe('manipulations', function() {

          xit('adds an item to the collection when add() is called', function() {
            expect(component.items.length).to.equal(0);
            component.add();
            expect(component.items.length).to.equal(1);
            expect(component.items[0].id).to.be.ok;
          });

          xit('removes the correct item from the collection when remove(id) is called', function() {
            component.items = ITEMS();
            component.remove(ITEMS()[0].id);
            expect(component.items[0].id).to.not.equal(ITEMS()[0].id);
          });

          xit('removes all Simpla data for an item when remove(id) is called', function() {
            Simpla.set(COLLECTION_PATH, {
              type: 'Collection',
              data: {
                items: ITEMS()
              }
            });
            component.remove(ITEMS()[0].id);
            expect(Simpla.get(COLLECTION_PATH + '/' + ITEMS()[0].id)).to.be.empty;
          });

          xit('swaps the correct items in the collection when swap(a, b) is called', function() {
            component.items = ITEMS();
            component.swap(ITEMS()[0].id, ITEMS()[1].id);
            expect(component.items[0].id).to.equal(ITEMS()[1].id);
            expect(component.items[1].id).to.equal(ITEMS()[0].id);
          });
        })
      });
    </script>
  </body>
</html>
